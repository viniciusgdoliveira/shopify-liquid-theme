{% comment %}
  Enhanced collection section with advanced filtering, sorting, and pagination.
  Features:
  - Advanced filtering (price, brand, color, size, rating)
  - Sorting options (price, popularity, newest, rating)
  - View toggle (grid/list)
  - Collection banner
  - Product count and filter management
  - AJAX filtering support
{% endcomment %}

{% liquid
  assign products_per_page = section.settings.products_per_page | default: 20
  assign show_collection_banner = section.settings.show_collection_banner
  assign show_collection_description = section.settings.show_collection_description
  assign show_sorting = section.settings.show_sorting
  assign show_filtering = section.settings.show_filtering
  assign show_view_toggle = section.settings.show_view_toggle
  assign show_product_count = section.settings.show_product_count
  assign default_view = section.settings.default_view | default: 'grid'
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 2
%}

<div class="collection collection--{{ default_view }} page-width">
  {% comment %} Breadcrumbs {% endcomment %}
  {% render 'breadcrumbs', collection: collection, class: 'collection__breadcrumbs' %}
  
  {% comment %} Collection Header {% endcomment %}
  <div class="collection__header">
    {% if show_collection_banner and collection.image %}
      <div class="collection__banner">
          {% render 'image',
          image: collection.image,
          class: 'collection__banner-image'
        %}
        <div class="collection__banner-content">
          <h1 class="collection__title">{{ collection.title | escape }}</h1>
          {% if show_collection_description and collection.description != blank %}
            <div class="collection__description rte">
              {{ collection.description }}
            </div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <div class="collection__header-content">
        <h1 class="collection__title">{{ collection.title | escape }}</h1>
        {% if show_collection_description and collection.description != blank %}
          <div class="collection__description rte">
            {{ collection.description }}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% comment %} Collection Controls {% endcomment %}
  <div class="collection__controls">
    <div class="collection__controls-left">
      {% if show_product_count %}
        <div class="collection__count">
          <span class="collection__count-text">
            {% if collection.products_count == 1 %}
              {{ 'collections.general.products_count.one' | t: count: collection.products_count }}
            {% else %}
              {{ 'collections.general.products_count.other' | t: count: collection.products_count }}
            {% endif %}
          </span>
        </div>
      {% endif %}
    </div>

    <div class="collection__controls-right">
      {% if show_sorting %}
        <div class="collection__sort">
          <label for="sort-by" class="collection__sort-label">{{ 'collections.general.sort_by' | t }}</label>
          <select id="sort-by" class="collection__sort-select" data-collection-sort>
            <option value="manual" {% if collection.sort_by == 'manual' %}selected{% endif %}>
              {{ 'collections.general.sort_by_manual' | t }}
            </option>
            <option value="best-selling" {% if collection.sort_by == 'best-selling' %}selected{% endif %}>
              {{ 'collections.general.sort_by_best_selling' | t }}
            </option>
            <option value="title-ascending" {% if collection.sort_by == 'title-ascending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_title_ascending' | t }}
            </option>
            <option value="title-descending" {% if collection.sort_by == 'title-descending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_title_descending' | t }}
            </option>
            <option value="price-ascending" {% if collection.sort_by == 'price-ascending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_price_ascending' | t }}
            </option>
            <option value="price-descending" {% if collection.sort_by == 'price-descending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_price_descending' | t }}
            </option>
            <option value="created-ascending" {% if collection.sort_by == 'created-ascending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_created_ascending' | t }}
            </option>
            <option value="created-descending" {% if collection.sort_by == 'created-descending' %}selected{% endif %}>
              {{ 'collections.general.sort_by_created_descending' | t }}
            </option>
          </select>
        </div>
      {% endif %}

      {% if show_view_toggle %}
        <div class="collection__view-toggle">
          <button type="button" class="collection__view-btn collection__view-btn--grid{% if default_view == 'grid' %} active{% endif %}" data-view="grid" aria-label="{{ 'collections.general.view_grid' | t }}">
            {% render 'icons', icon: 'grid' %}
          </button>
          <button type="button" class="collection__view-btn collection__view-btn--list{% if default_view == 'list' %} active{% endif %}" data-view="list" aria-label="{{ 'collections.general.view_list' | t }}">
            {% render 'icons', icon: 'list' %}
          </button>
        </div>
      {% endif %}
    </div>
  </div>

  {% comment %} Collection Filters {% endcomment %}
  {% if show_filtering %}
    <div class="collection__filters" data-collection-filters>
      <div class="collection__filters-header">
        <h3 class="collection__filters-title">{{ 'collections.general.filter_by' | t }}</h3>
        <button type="button" class="collection__filters-clear" data-clear-filters>
          {{ 'collections.general.clear_all' | t }}
        </button>
      </div>
      
      <div class="collection__filters-content">
        {% comment %} Price Filter {% endcomment %}
        <div class="collection__filter-group">
          <h4 class="collection__filter-title">{{ 'collections.general.price' | t }}</h4>
          <div class="collection__filter-price" data-price-filter>
            <input type="range" class="collection__filter-price-range" min="0" max="1000" step="10" data-price-min>
            <input type="range" class="collection__filter-price-range" min="0" max="1000" step="10" data-price-max>
            <div class="collection__filter-price-display">
              <span data-price-min-display>$0</span> - <span data-price-max-display>$1000</span>
            </div>
          </div>
        </div>

        {% comment %} Brand Filter {% endcomment %}
        {% if collection.all_vendors.size > 1 %}
          <div class="collection__filter-group">
            <h4 class="collection__filter-title">{{ 'collections.general.brand' | t }}</h4>
            <div class="collection__filter-options" data-brand-filter>
              {% for vendor in collection.all_vendors %}
                <label class="collection__filter-option">
                  <input type="checkbox" value="{{ vendor | escape }}" data-filter="vendor">
                  <span class="collection__filter-option-text">{{ vendor | escape }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% comment %} Color Filter {% endcomment %}
        {% assign color_options = collection.all_tags | where: 'Color' %}
        {% if color_options.size > 0 %}
          <div class="collection__filter-group">
            <h4 class="collection__filter-title">{{ 'collections.general.color' | t }}</h4>
            <div class="collection__filter-options collection__filter-colors" data-color-filter>
              {% for color in color_options %}
                {% assign color_name = color | remove: 'Color_' | downcase %}
                <label class="collection__filter-option collection__filter-color">
                  <input type="checkbox" value="{{ color | escape }}" data-filter="color">
                  <span class="collection__filter-color-swatch" style="background-color: {{ color_name }};" data-color="{{ color_name }}"></span>
                  <span class="collection__filter-option-text">{{ color | remove: 'Color_' | capitalize }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% comment %} Size Filter {% endcomment %}
        {% assign size_options = collection.all_tags | where: 'Size' %}
        {% if size_options.size > 0 %}
          <div class="collection__filter-group">
            <h4 class="collection__filter-title">{{ 'collections.general.size' | t }}</h4>
            <div class="collection__filter-options collection__filter-sizes" data-size-filter>
              {% for size in size_options %}
                <label class="collection__filter-option collection__filter-size">
                  <input type="checkbox" value="{{ size | escape }}" data-filter="size">
                  <span class="collection__filter-option-text">{{ size | remove: 'Size_' }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {% comment %} Availability Filter {% endcomment %}
        <div class="collection__filter-group">
          <h4 class="collection__filter-title">{{ 'collections.general.availability' | t }}</h4>
          <div class="collection__filter-options" data-availability-filter>
            <label class="collection__filter-option">
              <input type="checkbox" value="in_stock" data-filter="availability">
              <span class="collection__filter-option-text">{{ 'collections.general.in_stock' | t }}</span>
            </label>
            <label class="collection__filter-option">
              <input type="checkbox" value="on_sale" data-filter="availability">
              <span class="collection__filter-option-text">{{ 'collections.general.on_sale' | t }}</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} Collection Products {% endcomment %}
  <div class="collection__products" data-collection-products>
    {% paginate collection.products by products_per_page %}
      <div class="collection__products-grid collection__products-grid--{{ columns_desktop }}-col collection__products-grid--mobile-{{ columns_mobile }}-col">
        {% for product in collection.products %}
          <div class="collection__product" data-product-id="{{ product.id }}"{% if settings.enable_quickbuy %} data-quickbuy="true"{% endif %}>
            <div class="collection__product-card">
              {% if product.featured_image %}
                <div class="collection__product-image">
                  <a href="{{ product.url }}" class="collection__product-link">
                    {% render 'image',
                      image: product.featured_image,
                      class: 'collection__product-img',
                      width: 400,
                      height: 400,
                      crop: 'center'
                    %}
                  </a>
                  
                  {% if product.compare_at_price > product.price %}
                    <div class="collection__product-badge collection__product-badge--sale">
                      Sale
                    </div>
                  {% endif %}
                  
                  {% comment %} Add NEW badge for new products {% endcomment %}
                  {% assign product_age = product.created_at | date: '%s' %}
                  {% assign current_time = 'now' | date: '%s' %}
                  {% assign age_in_days = current_time | minus: product_age | divided_by: 86400 %}
                  {% if age_in_days <= 30 %}
                    <div class="collection__product-badge collection__product-badge--new">
                      NEW
                    </div>
                  {% endif %}
                  
                  {% comment %} Add BESTSELLER badge {% endcomment %}
                  {% if product.tags contains 'bestseller' %}
                    <div class="collection__product-badge collection__product-badge--bestseller">
                      BESTSELLER
                    </div>
                  {% endif %}
                  
                  {%- if settings.enable_quickbuy and product.available -%}
                    <div class="collection__product-quickbuy">
                      <button class="collection__quickbuy-btn" data-quickbuy-trigger data-product-id="{{ product.id }}">
                        <span class="sr-only">{{ 'products.product.quick_add' | t }}</span>
                        {% render 'icons', icon: 'plus' %}
                      </button>
                    </div>
                  {%- endif -%}
                  
                  {% if section.settings.show_quick_add %}
                    <div class="collection__product-actions">
                      <button type="button" class="collection__product-quick-add" data-quick-add="{{ product.id }}">
                        {{ 'products.product.quick_add' | t }}
                      </button>
                      <button type="button" class="collection__product-quick-view" data-quick-view="{{ product.id }}">
                        {{ 'products.product.quick_view' | t }}
                      </button>
                    </div>
                  {% endif %}
                </div>
              {% endif %}

              <div class="collection__product-content">
                <h3 class="collection__product-title">
                  <a href="{{ product.url }}" class="collection__product-link">
                    {{ product.title | escape }}
                  </a>
                </h3>

                {% if section.settings.show_vendor and product.vendor %}
                  <div class="collection__product-vendor">
                    {{ product.vendor | escape }}
                  </div>
                {% endif %}

                <div class="collection__product-price">
                  {% if product.compare_at_price > product.price %}
                    <span class="collection__product-price--sale">
                      {{ product.price | money }}
                    </span>
                    <span class="collection__product-price--compare">
                      {{ product.compare_at_price | money }}
                    </span>
                  {% else %}
                    <span class="collection__product-price--regular">
                      {{ product.price | money }}
                    </span>
                  {% endif %}
                </div>

                {% if section.settings.show_rating and product.metafields.reviews.rating.value %}
                  <div class="collection__product-rating">
                    {% assign rating = product.metafields.reviews.rating.value %}
                    <div class="collection__product-stars">
                      {% for i in (1..5) %}
                        <span class="collection__product-star{% if i <= rating %} active{% endif %}">★</span>
                      {% endfor %}
                    </div>
                    <span class="collection__product-rating-count">
                      ({{ product.metafields.reviews.rating_count.value }})
                    </span>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% else %}
          <div class="collection__empty">
            <h2 class="collection__empty-title">{{ 'collections.general.no_products' | t }}</h2>
            <p class="collection__empty-text">{{ 'collections.general.no_products_description' | t }}</p>
      </div>
    {% endfor %}
      </div>

      {% comment %} Enhanced Pagination {% endcomment %}
      {% if paginate.pages > 1 %}
        <div class="collection__pagination">
          <div class="collection__pagination-info">
            <span class="collection__pagination-text">
              {{ 'collections.general.pagination_info' | t: 
                current_page: paginate.current_page, 
                total_pages: paginate.pages,
                total_products: paginate.total 
              }}
            </span>
          </div>
          
          <div class="collection__pagination-controls">
            {% comment %} Previous Page {% endcomment %}
            {% if paginate.previous %}
              <a href="{{ paginate.previous.url }}" class="collection__pagination-btn collection__pagination-btn--prev" data-pagination="prev">
                {% render 'icons', icon: 'arrow-left' %}
                <span>{{ 'collections.general.previous' | t }}</span>
              </a>
            {% endif %}
            
            {% comment %} Page Numbers {% endcomment %}
            <div class="collection__pagination-numbers">
              {% for part in paginate.parts %}
                {% if part.is_link %}
                  <a href="{{ part.url }}" class="collection__pagination-number" data-page="{{ part.title }}">
                    {{ part.title }}
                  </a>
                {% elsif part.title == paginate.current_page %}
                  <span class="collection__pagination-number collection__pagination-number--current">
                    {{ part.title }}
                  </span>
                {% else %}
                  <span class="collection__pagination-number collection__pagination-number--dots">
                    {{ part.title }}
                  </span>
                {% endif %}
              {% endfor %}
            </div>
            
            {% comment %} Next Page {% endcomment %}
            {% if paginate.next %}
              <a href="{{ paginate.next.url }}" class="collection__pagination-btn collection__pagination-btn--next" data-pagination="next">
                <span>{{ 'collections.general.next' | t }}</span>
                {% render 'icons', icon: 'arrow-right' %}
              </a>
            {% endif %}
          </div>
          
          {% comment %} Load More Button {% endcomment %}
          {% if paginate.next %}
            <div class="collection__pagination-load-more">
              <button type="button" class="collection__load-more-btn" data-load-more="{{ paginate.next.url }}">
                <span class="collection__load-more-text">{{ 'collections.general.load_more' | t }}</span>
                <span class="collection__load-more-spinner" style="display: none;">
                  {% render 'icons', icon: 'spinner' %}
                </span>
              </button>
            </div>
          {% endif %}
        </div>
      {% endif %}
  {% endpaginate %}
  </div>
</div>

{% comment %} Quick View Modal {% endcomment %}
<div class="quick-view-modal" id="quick-view-modal" data-quick-view-modal>
  <div class="quick-view-modal__overlay" data-quick-view-close></div>
  <div class="quick-view-modal__content">
    <button type="button" class="quick-view-modal__close" data-quick-view-close aria-label="{{ 'products.product.close_modal' | t }}">
      <span>&times;</span>
    </button>
    <div class="quick-view-modal__body" data-quick-view-body>
      <!-- Product content will be loaded here -->
    </div>
  </div>
</div>

{% comment %}
  Collection section styles are now loaded from assets/collection.css
  Collection section scripts are now loaded from snippets/collection-scripts.liquid
{% endcomment %}

{% render 'collection-scripts' %}

{% comment %}
  Old JavaScript code removed - now using collection-scripts snippet
{% endcomment %}

{% schema %}
{
  "name": "t:general.collection",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Collection Display"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 12,
      "max": 48,
      "step": 4,
      "default": 20,
      "label": "Products per page"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "options": [
        {
          "value": "2",
          "label": "2 columns"
        },
        {
          "value": "3",
          "label": "3 columns"
        },
        {
          "value": "4",
          "label": "4 columns"
        }
      ],
      "default": "4",
      "label": "Desktop columns"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "2",
      "label": "Mobile columns"
    },
    {
      "type": "select",
      "id": "default_view",
      "options": [
        {
          "value": "grid",
          "label": "Grid view"
        },
        {
          "value": "list",
          "label": "List view"
        }
      ],
      "default": "grid",
      "label": "Default view"
    },
    {
      "type": "header",
      "content": "Collection Header"
    },
    {
      "type": "checkbox",
      "id": "show_collection_banner",
      "default": true,
      "label": "Show collection banner"
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "default": true,
      "label": "Show collection description"
    },
    {
      "type": "header",
      "content": "Collection Controls"
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "default": true,
      "label": "Show product count"
    },
    {
      "type": "checkbox",
      "id": "show_sorting",
      "default": true,
      "label": "Show sorting options"
    },
    {
      "type": "checkbox",
      "id": "show_view_toggle",
      "default": true,
      "label": "Show view toggle"
    },
    {
      "type": "checkbox",
      "id": "show_filtering",
      "default": true,
      "label": "Show filtering options"
    },
    {
      "type": "header",
      "content": "Product Cards"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show product rating"
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "default": true,
      "label": "Show quick add button"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
